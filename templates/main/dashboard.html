{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - QIOS Retail{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
    {% include 'main/sidebar.html' %}

    <main class="main-content">
        <header class="dashboard-header">
            <div class="header-left">
                <h2>Dashboard</h2>
                <div class="date-picker">
                    <input type="text" id="date-range-picker" placeholder="Pilih Rentang Waktu...">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <button class="add-record-btn" id="add-record-btn"><i class="fas fa-plus"></i> Add Dummy Data</button>
                
                <button class="add-record-btn" id="pay-button" style="background-color: #1a73e8;"><i class="fas fa-credit-card"></i> Pay (Demo)</button>
            </div>
            <div class="header-right">
                <div class="user-profile">
                    <span>{{ user.username }}</span>
                    <img src="{% static 'images/logo-bisnis.png' %}" alt="Business Logo">
                </div>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="card"><p>Jumlah Pemesanan</p><h2 id="total-orders">{{ total_orders }}</h2><small>↓ Wawasan Bisnis</small></div>
            <div class="card"><p>Total Pemasukan</p><h2 id="total-income">{{ total_income|default:"Rp 0.00" }}</h2><small>Hasil yang Disaring</small></div>
            <div class="card"><p>Total Pengeluaran</p><h2>n/a</h2><small>Hasil yang Disaring</small></div>
            <div class="card"><p>Margin Penghasilan</p><h2 id="total-revenue">{{ total_revenue|default:"Rp 0.00" }}</h2><small>↓ Wawasan Bisnis</small></div>
            <div class="card card-large" id="customer-order">
                <p>Input Manual dalam Rentang Waktu Terpilih</p>
                <div class="table-container">
                    <table id="records-table">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Pemasukan</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body">
                            {% for record in latest_records %}
                            <tr>
                                <td>{{ record.date|date:"d/m/Y" }}</td>
                                <td>Rp {{ record.income }}</td>
                                <td><span class="status confirmed">Terekam</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" style="text-align: center;">Belum ada record, tambahkan dummy data baru.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div class="modal-backdrop" id="record-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tambahkan Dummy Record Baru</h3>
                <button class="modal-close" id="modal-close-btn">&times;</button>
            </div>
            <form id="add-record-form" method="POST" action="{% url 'add_record' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="record-date-picker">Tanggal</label>
                    <input type="text" id="record-date-picker" name="date" placeholder="Click to select date..." required>
                </div>
                <div class="form-group">
                    <label for="income">Total Pemasukan</label>
                    <input type="number" id="income" name="income" step="0.01" placeholder="cth. 500000" required>
                </div>
                <div class="form-group">
                    <label for="expense">Total Pengeluaran</label>
                    <input type="number" id="expense" name="expense" step="0.01" placeholder="cth. 150000" required>
                </div>
                <div class="form-group">
                    <label for="orders_count">Jumlah Pesanan</label>
                    <input type="number" id="orders_count" name="orders_count" placeholder="cth. 25" required>
                </div>
                <button type="submit" class="modal-btn">Simpan Record</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // === KALENDER FILTER TANGGAL (KODE ASLI) ===
    const dateRangePicker = flatpickr("#date-range-picker", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates) {
            if (selectedDates.length === 2) {
                const startDate = selectedDates[0];
                const endDate = selectedDates[1];
                const formattedStartDate = startDate.toISOString().split('T')[0];
                const formattedEndDate = endDate.toISOString().split('T')[0];
                updateDashboardData(formattedStartDate, formattedEndDate);
            }
        }
    });

    // === FUNGSI UPDATE DASHBOARD (KODE ASLI) ===
    function updateDashboardData(startDate, endDate) {
        document.getElementById('total-orders').innerText = '...';
        document.getElementById('total-income').innerText = '...';
        document.getElementById('total-revenue').innerText = '...';
        document.getElementById('records-table-body').innerHTML = '<tr><td colspan="3" style="text-align: center;">Loading...</td></tr>';
        
        const url = `{% url 'filter_dashboard' %}?start_date=${startDate}&end_date=${endDate}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-orders').innerText = data.total_orders;
                document.getElementById('total-income').innerText = data.total_income;
                document.getElementById('total-revenue').innerText = data.total_revenue;

                const tableBody = document.getElementById('records-table-body');
                tableBody.innerHTML = '';
                if (data.records.length > 0) {
                    data.records.forEach(record => {
                        const row = `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.income}</td>
                                <td><span class="status confirmed">Recorded</span></td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No records found in this date range.</td></tr>';
                }
            })
            .catch(error => console.error('Error fetching filtered data:', error));
    }

    // === MODAL "ADD RECORD" (KODE ASLI) ===
    const recordDatePicker = flatpickr("#record-date-picker", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "F j, Y",
        defaultDate: "today"
    });

    const modal = document.getElementById('record-modal');
    const openBtn = document.getElementById('add-record-btn');
    const closeBtn = document.getElementById('modal-close-btn');
    const form = document.getElementById('add-record-form');

    openBtn.addEventListener('click', () => modal.style.display = 'flex');
    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    // === SUBMIT "ADD RECORD" (KODE ASLI) ===
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.date = recordDatePicker.selectedDates[0] ? recordDatePicker.formatDate(recordDatePicker.selectedDates[0], "Y-m-d") : '';
        
        if (!data.date) {
            alert("Please select a date.");
            return;
        }

        fetch("{% url 'add_record' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                window.location.href = window.location.pathname;
            } else {
                alert('An error occurred: '.concat(result.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the data.');
        });
    });

    // === LOGIKA BARU UNTUK MIDTRANS ===
    const payButton = document.getElementById('pay-button');
    // Kita ambil CSRF token dari form 'add record' yang sudah ada di halaman
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value; 

    payButton.addEventListener('click', function() {
        console.log("Pay button clicked. Requesting payment token...");
        
        // 1. Minta token ke server Django-mu
        fetch("{% url 'create_payment' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Kirim CSRF token
            },
            body: JSON.stringify({}) // Kirim body kosong aja buat demo
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                console.log("Token received:", result.token);
                
                // 2. Kalo dapet token, panggil pop-up Midtrans
                window.snap.pay(result.token, {
                    onSuccess: function(result){
                        alert("Pembayaran sukses!"); 
                        console.log(result);
                        // Kalo sukses, refresh halaman buat update data (misalnya)
                        window.location.href = window.location.pathname;
                    },
                    onPending: function(result){
                        alert("Pembayaran ditunda. Selesaikan di channel pembayaranmu."); 
                        console.log(result);
                    },
                    onError: function(result){
                        alert("Pembayaran gagal."); 
                        console.log(result);
                    },
                    onClose: function(){
                        console.log('User closed the popup without finishing payment.');
                    }
                });
            } else {
                alert('Gagal membuat transaksi: '.concat(result.message));
            }
        })
        .catch(error => {
            console.error('Error creating payment:', error);
            alert('An error occurred while creating the payment.');
        });
    });

});
</script>
{% endblock %}