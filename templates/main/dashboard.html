{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - QIOS Retail{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
    {% include 'main/sidebar.html' %}

    <main class="main-content">
        <header class="dashboard-header">
            <div class="header-left">
                <h2>Dashboard</h2>
                <div class="date-picker">
                    <input type="text" id="date-range-picker" placeholder="Select Date Range...">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <button class="add-record-btn" id="add-record-btn"><i class="fas fa-plus"></i> Add Manual Data</button>
            </div>
            <div class="header-right">
                <div class="user-profile">
                    <span>{{ user.username }}</span>
                    <img src="{% static 'images/logo-bisnis.png' %}" alt="Business Logo">
                </div>
            </div>
        </header>

        <div class="dashboard-grid">
            <div class="card"><p>Total Orders</p><h2 id="total-orders">{{ total_orders }}</h2><small>Filtered Results</small></div>
            <div class="card"><p>Pending</p><h2>n/a</h2><small>â†“ Business Insight</small></div>
            <div class="card"><p>Total Income</p><h2 id="total-income">{{ total_income|default:"Rp 0.00" }}</h2><small>Filtered Results</small></div>
            <div class="card"><p>Revenue</p><h2 id="total-revenue">{{ total_revenue|default:"Rp 0.00" }}</h2><small>Filtered Results</small></div>
            <div class="card card-large" id="customer-order">
                <p>Manual Inputs in Selected Range</p>
                <div class="table-container">
                    <table id="records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Income</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body">
                            {% for record in latest_records %}
                            <tr>
                                <td>{{ record.date|date:"d/m/Y" }}</td>
                                <td>Rp {{ record.income }}</td>
                                <td><span class="status confirmed">Recorded</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" style="text-align: center;">No records yet. Add your first manual data!</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div class="modal-backdrop" id="record-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Daily Record</h3>
                <button class="modal-close" id="modal-close-btn">&times;</button>
            </div>
            <form id="add-record-form" method="POST" action="{% url 'add_record' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="record-date-picker">Date</label>
                    <input type="text" id="record-date-picker" name="date" placeholder="Click to select date..." required>
                </div>
                <div class="form-group">
                    <label for="income">Total Income (Pemasukan)</label>
                    <input type="number" id="income" name="income" step="0.01" placeholder="e.g., 500000" required>
                </div>
                <div class="form-group">
                    <label for="expense">Total Expense (Pengeluaran)</label>
                    <input type="number" id="expense" name="expense" step="0.01" placeholder="e.g., 150000" required>
                </div>
                <div class="form-group">
                    <label for="orders_count">Total Orders (Jumlah Pesanan)</label>
                    <input type="number" id="orders_count" name="orders_count" placeholder="e.g., 25" required>
                </div>
                <button type="submit" class="modal-btn">Save Record</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateRangePicker = flatpickr("#date-range-picker", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates) {
            if (selectedDates.length === 2) {
                const startDate = selectedDates[0];
                const endDate = selectedDates[1];
                const formattedStartDate = startDate.toISOString().split('T')[0];
                const formattedEndDate = endDate.toISOString().split('T')[0];
                updateDashboardData(formattedStartDate, formattedEndDate);
            }
        }
    });

    function updateDashboardData(startDate, endDate) {
        document.getElementById('total-orders').innerText = '...';
        document.getElementById('total-income').innerText = '...';
        document.getElementById('total-revenue').innerText = '...';
        document.getElementById('records-table-body').innerHTML = '<tr><td colspan="3" style="text-align: center;">Loading...</td></tr>';
        
        const url = `{% url 'filter_dashboard' %}?start_date=${startDate}&end_date=${endDate}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-orders').innerText = data.total_orders;
                document.getElementById('total-income').innerText = data.total_income;
                document.getElementById('total-revenue').innerText = data.total_revenue;

                const tableBody = document.getElementById('records-table-body');
                tableBody.innerHTML = '';
                if (data.records.length > 0) {
                    data.records.forEach(record => {
                        const row = `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.income}</td>
                                <td><span class="status confirmed">Recorded</span></td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No records found in this date range.</td></tr>';
                }
            })
            .catch(error => console.error('Error fetching filtered data:', error));
    }

    const recordDatePicker = flatpickr("#record-date-picker", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "F j, Y",
        defaultDate: "today"
    });

    const modal = document.getElementById('record-modal');
    const openBtn = document.getElementById('add-record-btn');
    const closeBtn = document.getElementById('modal-close-btn');
    const form = document.getElementById('add-record-form');

    openBtn.addEventListener('click', () => modal.style.display = 'flex');
    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.date = recordDatePicker.selectedDates[0] ? recordDatePicker.formatDate(recordDatePicker.selectedDates[0], "Y-m-d") : '';
        
        if (!data.date) {
            alert("Please select a date.");
            return;
        }

        fetch("{% url 'add_record' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                window.location.href = window.location.pathname;
            } else {
                alert('An error occurred: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the data.');
        });
    });
});
</script>
{% endblock %}